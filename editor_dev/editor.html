<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¸¸æˆç¼–è¾‘å™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¼•å…¥JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- å¼•å…¥AJVéªŒè¯åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv7.min.js"></script>
    <!-- å¼•å…¥å¿…è¦çš„æ¨¡å— -->
    <script src="editorResource/enemy_spawn_validator.js"></script>
    <script src="editorResource/deepseek_json_generator.js"></script>
    <script src="editorResource/packing_rule_manager.js"></script>
    <script src="editorResource/localStorage_manager.js"></script>
    <script src="editorResource/ai_integration.js"></script>
    <script src="editorResource/editor_main.js"></script>
    <script src="editorResource/game_test_manager.js"></script>
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="editorResource/editor_styles.css">
</head>
<body>
    <div class="container">
        <h2>æ¸¸æˆç¼–è¾‘å™¨</h2>
        
        <div class="status-display">
            <span id="gameStatus" class="status-draft">çŠ¶æ€: è‰ç¨¿</span>
        </div>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="section">
            <h3>åŸºæœ¬ä¿¡æ¯</h3>
            <div class="form-group">
                <label class="form-label">æ¸¸æˆåç§°</label>
                <input type="text" id="gameTitle" class="form-input" placeholder="è¾“å…¥æ¸¸æˆåç§°" value="æˆ‘çš„å°„å‡»æ¸¸æˆ">
            </div>
            <div class="form-group">
                <label class="form-label">æ¸¸æˆæè¿°</label>
                <textarea id="gameDescription" class="form-input form-textarea" placeholder="è¾“å…¥æ¸¸æˆæè¿°">ä¸€æ¬¾åˆºæ¿€çš„å°„å‡»æ¸¸æˆï¼Œå‡»è´¥æ‰€æœ‰æ•Œäººï¼</textarea>
            </div>
        </div>
        
        <!-- AI ç”Ÿæˆæ•Œäººæ•°æ® -->
        <div class="section">
            <h3>AI ç”Ÿæˆæ•Œäººæ•°æ®</h3>
            <div class="ai-json-container">
                <div class="ai-input-panel">
                    <div class="ai-panel-title">ğŸ“ æè¿°ä½ çš„æ¸¸æˆ</div>
                    <textarea id="aiGameDescription" class="ai-textarea" placeholder="è¯·æè¿°ä½ æƒ³è¦çš„æ¸¸æˆç©æ³•ï¼Œä¾‹å¦‚ï¼š&#10;- æ¸¸æˆéš¾åº¦ï¼ˆç®€å•/æ™®é€š/å›°éš¾ï¼‰&#10;- æ¸¸æˆæ—¶é•¿ï¼ˆ30ç§’/60ç§’/90ç§’ï¼‰&#10;- æ•Œäººå‡ºç°æ–¹å¼ï¼ˆå¯†é›†/ç¨€ç–/é€æ¸å¢åŠ ï¼‰&#10;- ç‰¹æ®Šè¦æ±‚ç­‰...&#10;&#10;ç¤ºä¾‹ï¼šæˆ‘æƒ³è¦ä¸€ä¸ª60ç§’çš„å°„å‡»æ¸¸æˆï¼Œéš¾åº¦é€‚ä¸­ï¼Œæ•Œäººé€æ¸å¢å¤šï¼Œæœ€å30ç§’æ¯”è¾ƒæ¿€çƒˆ">æˆ‘æƒ³è¦ä¸€ä¸ª60ç§’çš„å°„å‡»æ¸¸æˆï¼Œéš¾åº¦é€‚ä¸­ï¼Œæ•Œäººé€æ¸å¢å¤šï¼Œæœ€å30ç§’æ¯”è¾ƒæ¿€çƒˆ</textarea>
                    <button class="ai-generate-btn" id="generateAIBtn" onclick="generateEnemyDataWithAI()">ğŸ¤– AI ç”Ÿæˆæ•°æ®</button>
                    <div id="aiStatus" class="ai-status hidden"></div>
                </div>
                
                <div class="ai-output-panel">
                    <div class="ai-panel-title">âš¡ ç”Ÿæˆçš„ JSON æ•°æ®</div>
                    <textarea id="jsonPreview" class="ai-textarea json-preview" readonly placeholder="AI ç”Ÿæˆçš„æ•Œäººæ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                    <button class="upload-btn" id="useAIDataBtn" onclick="useGeneratedData()" style="background: #6bb6ff; margin-top: 8px;" disabled>âœ“ ä½¿ç”¨æ­¤æ•°æ®</button>
                </div>
            </div>
            <div class="tip">
                AI å°†æ ¹æ®ä½ çš„æè¿°ç”Ÿæˆç¬¦åˆæ¸¸æˆè§„åˆ™çš„æ•Œäººç”Ÿæˆæ•°æ®ã€‚ç”Ÿæˆåå¯ä»¥é¢„è§ˆå¹¶é€‰æ‹©ä½¿ç”¨ã€‚
            </div>
        </div>
        
        <!-- æ•Œäººå¤´åƒ -->
        <div class="section">
            <h3>æ•Œäººå¤´åƒ</h3>
            <div class="enemy-avatars-grid">
                <div class="enemy-avatar-item">
                    <div id="enemyPreview0" class="enemy-preview empty" onclick="selectEnemyFile(0)">
                        ç‚¹å‡»ä¸Šä¼ <br>æ•Œäºº0
                    </div>
                    <button class="upload-btn" onclick="selectEnemyFile(0)">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                <div class="enemy-avatar-item">
                    <div id="enemyPreview1" class="enemy-preview empty" onclick="selectEnemyFile(1)">
                        ç‚¹å‡»ä¸Šä¼ <br>æ•Œäºº1
                    </div>
                    <button class="upload-btn" onclick="selectEnemyFile(1)">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                <div class="enemy-avatar-item">
                    <div id="enemyPreview2" class="enemy-preview empty" onclick="selectEnemyFile(2)">
                        ç‚¹å‡»ä¸Šä¼ <br>æ•Œäºº2
                    </div>
                    <button class="upload-btn" onclick="selectEnemyFile(2)">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                <div class="enemy-avatar-item">
                    <div id="enemyPreview3" class="enemy-preview empty" onclick="selectEnemyFile(3)">
                        ç‚¹å‡»ä¸Šä¼ <br>æ•Œäºº3
                    </div>
                    <button class="upload-btn" onclick="selectEnemyFile(3)">é€‰æ‹©æ–‡ä»¶</button>
                </div>
            </div>
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
            <input type="file" id="enemyFileInput0" class="hidden" accept="image/*" onchange="handleEnemyFileChange(0)">
            <input type="file" id="enemyFileInput1" class="hidden" accept="image/*" onchange="handleEnemyFileChange(1)">
            <input type="file" id="enemyFileInput2" class="hidden" accept="image/*" onchange="handleEnemyFileChange(2)">
            <input type="file" id="enemyFileInput3" class="hidden" accept="image/*" onchange="handleEnemyFileChange(3)">
        </div>
        
        <!-- èƒŒæ™¯éŸ³ä¹ -->
        <div class="section">
            <h3>èƒŒæ™¯éŸ³ä¹</h3>
            <div class="audio-section">
                <div id="audioPreview" class="audio-preview empty" onclick="selectAudioFile()">
                    ç‚¹å‡»ä¸Šä¼ èƒŒæ™¯éŸ³ä¹ (MP3)
                </div>
                <button class="upload-btn" onclick="selectAudioFile()">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</button>
                <input type="file" id="audioFileInput" class="hidden" accept="audio/*" onchange="handleAudioFileChange()">
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="button-group">
            <button class="export-btn" id="exportBtn" onclick="exportLocalEdit()">å¯¼å‡ºé…ç½®</button>
            <button class="export-btn publish-btn" id="publishBtn" onclick="publishLocalEdit()">å‘å¸ƒåŒæ¬¾</button>
        </div>
        
        <div class="tip">
            <strong>å¯¼å‡ºé…ç½®</strong>ï¼šä¸‹è½½åŒ…å«ä½ ç¼–è¾‘å†…å®¹çš„ MOD æ–‡ä»¶åŒ…ï¼ˆåŒ…æ‹¬æ•Œäººæ•°æ®ã€å¤´åƒã€éŸ³é¢‘ç­‰ï¼‰<br>
            <strong>å‘å¸ƒåŒæ¬¾</strong>ï¼šå°†ä½ çš„ä½œå“å‘å¸ƒåˆ°ç½‘ç«™ï¼Œä¾›å…¶ä»–ç”¨æˆ·æ¸¸ç©å’Œä¸‹è½½
        </div>
    </div>

    <script>
        /* ========================================================================
         * åç«¯æ¥å£å‡½æ•° - ç”±åŒäº‹è´Ÿè´£ç»´æŠ¤
         * ========================================================================
         * ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°æ˜¯ä¸ç½‘ç«™åç«¯å¯¹é½çš„æ ¸å¿ƒæ¥å£å‡½æ•°ï¼Œè¯·å‹¿éšæ„ä¿®æ”¹å‡½æ•°åå’Œè¿”å›æ ¼å¼
         * å¦‚éœ€ä¿®æ”¹å†…éƒ¨å®ç°ï¼Œè¯·è”ç³»åç«¯åŒäº‹ç¡®è®¤æ¥å£åè®®
         */

        /**
         * è·å– MOD æ•°æ®åŒ…ï¼ˆä»…åŒ…å« mod/ ç›®å½•ï¼‰
         * 
         * ã€æ ¸å¿ƒæ¥å£å‡½æ•° - åç«¯å‘å¸ƒç”¨ã€‘
         * 
         * åŠŸèƒ½è¯´æ˜ï¼š
         * 1. æ”¶é›†ç”¨æˆ·ç¼–è¾‘çš„ MOD å†…å®¹ï¼ˆæ•Œäººæ•°æ®ã€å¤´åƒã€éŸ³é¢‘ç­‰ï¼‰
         * 2. åªæ‰“åŒ… mod/ ç›®å½•ï¼Œä¸åŒ…å«æ¸¸æˆæœ¬ä½“æ–‡ä»¶
         * 3. ç”¨äºå‘å¸ƒåˆ°åç«¯æœåŠ¡å™¨
         * 
         * ZIPåŒ…å†…éƒ¨ç»“æ„ï¼š
         * mod/
         *   â”œâ”€â”€ enemy_spawn_data.json  // AIç”Ÿæˆæˆ–é»˜è®¤çš„æ•Œäººç”Ÿæˆæ•°æ®
         *   â”œâ”€â”€ texture/
         *   â”‚   â”œâ”€â”€ enemy0.png         // æ•Œäººå¤´åƒï¼ˆè½¬æ¢ä¸ºPNGæ ¼å¼ï¼‰
         *   â”‚   â”œâ”€â”€ enemy1.png
         *   â”‚   â”œâ”€â”€ enemy2.png
         *   â”‚   â””â”€â”€ enemy3.png
         *   â””â”€â”€ audio/
         *       â””â”€â”€ bgm.mp3            // èƒŒæ™¯éŸ³ä¹
         */
        async function getLocalEditData() {
            // æ›´æ–°æ¸¸æˆæ•°æ®ï¼ˆä»è¡¨å•è·å–æœ€æ–°è¾“å…¥ï¼‰
            window.gameData.title = document.getElementById('gameTitle').value;
            window.gameData.description = document.getElementById('gameDescription').value;
            
            // åˆ›å»ºZIPåŒ… - åªåŒ…å« mod ç›®å½•
            const zip = new JSZip();
            const modFolder = zip.folder("mod");
            const textureFolder = modFolder.folder("texture");
            const audioFolder = modFolder.folder("audio");
            
            // è·å–æ•Œäººç”Ÿæˆæ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨AIç”Ÿæˆçš„æ•°æ®ï¼‰
            let enemySpawnData = window.gameData.enemySpawnData;
            if (enemySpawnData) {
                modFolder.file("enemy_spawn_data.json", JSON.stringify(enemySpawnData, null, 2));
            }
            // æ·»åŠ æ•Œäººå¤´åƒåˆ°textureæ–‡ä»¶å¤¹ï¼ˆè½¬æ¢ä¸ºPNGæ ¼å¼ï¼‰
            for (let i = 0; i < 4; i++) {
                const file = window.gameData.enemyFiles[i];
                if (file) {
                    const pngBlob = await convertImageToPng(file);
                    textureFolder.file(`enemy${i}.png`, pngBlob);
                }
            }
            
            // æ·»åŠ èƒŒæ™¯éŸ³ä¹
            if (window.gameData.audioFile) {
                audioFolder.file("bgm.mp3", window.gameData.audioFile);
            }
            
            // ç”ŸæˆZIPæ–‡ä»¶
            const zipBlob = await zip.generateAsync({type: "blob"});
            
            return {
                title: window.gameData.title,
                description: window.gameData.description,
                zipBlob: zipBlob,
            };
        }

        /**
         * è·å–å®Œæ•´æ¸¸æˆæ•°æ®åŒ…ï¼ˆåŒ…å«æ¸¸æˆæ–‡ä»¶ + mod/ ç›®å½•ï¼‰
         * 
         * ã€ç”¨æˆ·å¯¼å‡ºä¸‹è½½ç”¨ã€‘
         * 
         * åŠŸèƒ½è¯´æ˜ï¼š
         * 1. ç­‰å¾… packing_rule.json åŠ è½½å®Œæˆ
         * 2. æ ¹æ®è§„åˆ™è¯†åˆ«æ¸¸æˆæœ¬ä½“æ–‡ä»¶
         * 3. ä½¿ç”¨ fetch è·å–æ¸¸æˆæ–‡ä»¶
         * 4. æ·»åŠ ç”¨æˆ·ç¼–è¾‘çš„ MOD å†…å®¹
         * 5. æ‰“åŒ…ä¸ºå®Œæ•´å¯ç©çš„æ¸¸æˆåŒ…
         * 
         * ZIPåŒ…å†…éƒ¨ç»“æ„ï¼š
         * â”œâ”€â”€ index.html              // æ¸¸æˆå…¥å£æ–‡ä»¶
         * â”œâ”€â”€ Build/                  // æ¸¸æˆå¼•æ“æ–‡ä»¶
         * â”œâ”€â”€ GameContainerData/      // æ¸¸æˆå®¹å™¨æ•°æ®
         * â””â”€â”€ mod/                    // ç”¨æˆ·MODå†…å®¹
         *     â”œâ”€â”€ enemy_spawn_data.json
         *     â”œâ”€â”€ texture/
         *     â””â”€â”€ audio/
         */
        async function getCompleteGameData() {
            try {
                // 1. ç­‰å¾…æ‰“åŒ…è§„åˆ™åŠ è½½å®Œæˆ
                await packingRuleManager.waitForRulesLoaded();
                
                // 2. è·å– MOD æ•°æ®
                const modData = await getLocalEditData();
                
                // 3. åˆ›å»ºæ–°çš„ZIPåŒ…ï¼ŒåŒ…å«å®Œæ•´æ¸¸æˆ
                const zip = new JSZip();
                
                // 4. è·å–æ‰“åŒ…è§„åˆ™ä¿¡æ¯
                const rulesInfo = packingRuleManager.getRulesInfo();
                const gamePatterns = packingRuleManager.getGameFilePatterns();
                
                // 5. è·å–æ‰€æœ‰éœ€è¦çš„æ¸¸æˆæ–‡ä»¶
                const gameFiles = await fetchGameFiles(gamePatterns);
                
                // 6. å°†æ¸¸æˆæ–‡ä»¶æ·»åŠ åˆ°ZIPåŒ…ä¸­
                for (const gameFile of gameFiles) {
                    zip.file(gameFile.path, gameFile.content);
                }
                
                // 7. æ·»åŠ  packing_rule.json ä¾›å‚è€ƒ
                zip.file("packing_rule.json", JSON.stringify(packingRuleManager.rules, null, 2));
                
                // 8. è§£å‹å¹¶æ·»åŠ  MOD æ•°æ®
                const modZip = await JSZip.loadAsync(modData.zipBlob);
                for (const [relativePath, zipEntry] of Object.entries(modZip.files)) {
                    if (!zipEntry.dir) {
                        const content = await zipEntry.async('blob');
                        zip.file(relativePath, content);
                    }
                }
                
                // 9. åˆ›å»ºè¯´æ˜æ–‡ä»¶
                const instructionText = `å®Œæ•´æ¸¸æˆåŒ…ä½¿ç”¨è¯´æ˜ï¼š

=== æ¸¸æˆä¿¡æ¯ ===
æ¸¸æˆæ ‡é¢˜ï¼š${modData.title}
æ¸¸æˆæè¿°ï¼š${modData.description}
åˆ›å»ºæ—¶é—´ï¼š${new Date().toLocaleString()}
æ‰“åŒ…è§„åˆ™ç‰ˆæœ¬ï¼š${rulesInfo.version}

=== ä½¿ç”¨è¯´æ˜ ===
1. æœ¬ZIPåŒ…å«å®Œæ•´çš„æ¸¸æˆæ–‡ä»¶å’Œä½ ç¼–è¾‘çš„MODå†…å®¹
2. è§£å‹ååŒå‡» index.html å³å¯å¼€å§‹æ¸¸æˆ
3. æ‰€æœ‰æ–‡ä»¶éƒ½å·²åŒ…å«ï¼Œæ— éœ€é¢å¤–æ“ä½œ

=== åŒ…å«çš„æ¸¸æˆæ–‡ä»¶ ===
${gameFiles.map(file => `   - ${file.path}`).join('\n')}

=== ç›®å½•ç»“æ„ ===
æ¸¸æˆç›®å½•/
â”œâ”€â”€ index.html
â”œâ”€â”€ Build/
â”œâ”€â”€ GameContainerData/
â”œâ”€â”€ packing_rule.json
â””â”€â”€ mod/ (ä½ çš„MODå†…å®¹)
    â”œâ”€â”€ enemy_spawn_data.json
    â”œâ”€â”€ texture/
    â””â”€â”€ audio/

=== æŠ€æœ¯ä¿¡æ¯ ===
æ‰“åŒ…è§„åˆ™: ${rulesInfo.description}
æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${rulesInfo.ruleTypes.join(', ')}
åŒ…å«æ¸¸æˆæ–‡ä»¶æ•°é‡: ${gameFiles.length}`;

                zip.file("README.txt", instructionText);
                
                // 10. ç”Ÿæˆå®Œæ•´ZIPæ–‡ä»¶
                const completeZipBlob = await zip.generateAsync({type: "blob"});
                
                return {
                    title: modData.title,
                    description: modData.description,
                    zipBlob: completeZipBlob,
                };
                
            } catch (error) {
                console.error('åˆ›å»ºå®Œæ•´æ¸¸æˆåŒ…å¤±è´¥:', error);
                
                // å‡ºé”™æ—¶è¿”å›åŸºç¡€çš„ MOD åŒ…ï¼Œå¹¶é™„åŠ é”™è¯¯è¯´æ˜
                const modData = await getLocalEditData();
                const zip = new JSZip();
                
                const errorText = `å¯¼å‡ºå‡ºç°é—®é¢˜

é”™è¯¯ä¿¡æ¯ï¼š${error.message}

è¿™ä¸ªåŒ…ç›®å‰åªåŒ…å« MOD å†…å®¹ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ æ¸¸æˆæ–‡ä»¶ï¼š
1. å°† mod/ æ–‡ä»¶å¤¹å¤åˆ¶åˆ°æ¸¸æˆç›®å½•
2. ç¡®ä¿æ¸¸æˆçš„ index.htmlã€Build/ã€GameContainerData/ å­˜åœ¨
3. åŒå‡» index.html å¯åŠ¨æ¸¸æˆ

æ¸¸æˆæ ‡é¢˜ï¼š${modData.title}
æ¸¸æˆæè¿°ï¼š${modData.description}
åˆ›å»ºæ—¶é—´ï¼š${new Date().toLocaleString()}`;

                zip.file("ERROR_README.txt", errorText);
                
                // æ·»åŠ  MOD æ•°æ®
                const modZip = await JSZip.loadAsync(modData.zipBlob);
                for (const [relativePath, zipEntry] of Object.entries(modZip.files)) {
                    if (!zipEntry.dir) {
                        const content = await zipEntry.async('blob');
                        zip.file(relativePath, content);
                    }
                }
                
                const fallbackZipBlob = await zip.generateAsync({type: "blob"});
                
                return {
                    title: modData.title,
                    description: modData.description,
                    zipBlob: fallbackZipBlob,
                };
            }
        }

        /**
         * æ ¹æ®æ‰“åŒ…è§„åˆ™è·å–æ¸¸æˆæ–‡ä»¶
         * 
         * åŠŸèƒ½è¯´æ˜ï¼š
         * 1. ä» packing_rule.json ä¸­çš„ 'game_files' åŸŸè·å–æ–‡ä»¶åˆ—è¡¨
         * 2. è¿”å›æ–‡ä»¶è·¯å¾„å’Œå†…å®¹çš„æ•°ç»„
         * 
         * @param {string[]} gamePatterns - æ¸¸æˆæ–‡ä»¶çš„æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼ˆæœªä½¿ç”¨ï¼Œä¿ç•™æ¥å£å…¼å®¹æ€§ï¼‰
         * @returns {Promise<Array<{path: string, content: Blob}>>} æ¸¸æˆæ–‡ä»¶æ•°ç»„
         */
        async function fetchGameFiles(gamePatterns) {
            const gameFiles = [];
            
            // ä» packing_rule.json ä¸­çš„ game_files åŸŸè·å–æ–‡ä»¶åˆ—è¡¨
            if (packingRuleManager.rules && packingRuleManager.rules.game_files) {
                console.log('ä½¿ç”¨ packing_rule.json ä¸­çš„ game_files åŸŸè·å–æ¸¸æˆæ–‡ä»¶');
                const gameFilesInfo = packingRuleManager.rules.game_files;
                
                if (gameFilesInfo.files && Array.isArray(gameFilesInfo.files)) {
                    console.log(`æ‰¾åˆ° ${gameFilesInfo.files.length} ä¸ªæ¸¸æˆæ–‡ä»¶ (æ‰«ææ—¶é—´: ${gameFilesInfo.scan_time})`);
                    
                    for (const relativePath of gameFilesInfo.files) {
                        try {
                            // æ–‡ä»¶è·¯å¾„ç›¸å¯¹äºå½“å‰è¿è¡Œçš„ editor.html (åœ¨buildç›®å½•ä¸‹)
                            const filePath = `./${relativePath}`;
                            console.log(`æ­£åœ¨è·å–æ¸¸æˆæ–‡ä»¶: ${filePath}`);
                            const response = await fetch(filePath);
                            
                            if (response.ok) {
                                const content = await response.blob();
                                gameFiles.push({
                                    path: relativePath,
                                    content: content
                                });
                                console.log(`æˆåŠŸè·å–æ¸¸æˆæ–‡ä»¶: ${relativePath}`);
                            } else {
                                console.warn(`æ— æ³•è·å–æ¸¸æˆæ–‡ä»¶: ${filePath} (çŠ¶æ€: ${response.status})`);
                            }
                        } catch (error) {
                            console.error(`è·å–æ¸¸æˆæ–‡ä»¶å¤±è´¥: ${relativePath}`, error);
                        }
                    }
                    
                    console.log(`ä» game_files åŸŸè·å–åˆ° ${gameFiles.length} ä¸ªæ¸¸æˆæ–‡ä»¶`);
                } else {
                    console.warn('game_files åŸŸå­˜åœ¨ä½†æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                }
            } else {
                console.error('packing_rule.json ä¸­æœªæ‰¾åˆ° game_files åŸŸ');
                console.error('è¯·ç¡®ä¿è¿è¡Œäº†æ„å»ºè„šæœ¬ä»¥ç”Ÿæˆ game_files åŸŸ');
                throw new Error('Missing game_files domain in packing_rule.json. Please run build script first.');
            }
            
            console.log(`æ€»å…±è·å–åˆ° ${gameFiles.length} ä¸ªæ¸¸æˆæ–‡ä»¶`);
            return gameFiles;
        }



        /**
         * å¯¼å‡ºé…ç½®
         * 
         * ã€ç”¨æˆ·ä¸‹è½½å®Œæ•´æ¸¸æˆåŒ…ã€‘
         * 
         * åŠŸèƒ½è¯´æ˜ï¼š
         * 1. è°ƒç”¨ getCompleteGameData() è·å–å®Œæ•´æ¸¸æˆåŒ…ï¼ˆæ¸¸æˆæ–‡ä»¶ + MODï¼‰
         * 2. è§¦å‘æµè§ˆå™¨ä¸‹è½½ZIPæ–‡ä»¶
         * 3. ç”¨æˆ·ä¸‹è½½åè§£å‹å³å¯æœ¬åœ°æ¸¸ç©
         * 4. å¤„ç†å¯¼å‡ºè¿‡ç¨‹ä¸­çš„UIçŠ¶æ€å’Œé”™è¯¯
         * 
         * ç”¨æˆ·ä½“éªŒï¼š
         * - ç‚¹å‡»"å¯¼å‡ºé…ç½®"æŒ‰é’®æ—¶è°ƒç”¨
         * - å¯¼å‡ºè¿‡ç¨‹ä¸­æŒ‰é’®æ˜¾ç¤º"å¯¼å‡ºä¸­..."å¹¶ç¦ç”¨
         * - ä¸‹è½½åŒ…å«æ¸¸æˆæœ¬ä½“ + ç”¨æˆ·MODå†…å®¹çš„å®Œæ•´åŒ…
         * - æˆåŠŸåæ¢å¤æŒ‰é’®çŠ¶æ€
         * 
         * æ–‡ä»¶å‘½åè§„åˆ™ï¼š
         * - ä¸‹è½½æ–‡ä»¶åæ ¼å¼ï¼š"{æ¸¸æˆæ ‡é¢˜}-complete.zip"
         * - å¦‚æœæ¸¸æˆæ ‡é¢˜ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ "game-complete.zip"
         * 
         * æ³¨æ„äº‹é¡¹ï¼š
         * - ä¸ publishLocalEdit ä¸åŒï¼Œæ­¤å‡½æ•°ä¸‹è½½å®Œæ•´æ¸¸æˆåŒ…
         * - åŒ…å« README.txt è¯´æ˜æ–‡ä»¶æŒ‡å¯¼ç”¨æˆ·ä½¿ç”¨
         * - ä¾èµ–DOMå…ƒç´ ï¼š#exportBtnï¼ˆå¯¼å‡ºæŒ‰é’®ï¼‰
         */
        async function exportLocalEdit() {
            try {
                const btn = document.getElementById('exportBtn');
                btn.disabled = true;
                btn.textContent = 'å¯¼å‡ºä¸­...';
                
                const data = await getCompleteGameData();
                
                const url = URL.createObjectURL(data.zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.title || 'game'}-complete.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                btn.disabled = false;
                btn.textContent = 'å¯¼å‡ºé…ç½®';
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                
                const btn = document.getElementById('exportBtn');
                btn.disabled = false;
                btn.textContent = 'å¯¼å‡ºé…ç½®';
            }
        }

        /**
         * å‘å¸ƒåŒæ¬¾
         * 
         * ã€æ ¸å¿ƒæ¥å£å‡½æ•° - åç«¯å¯¹æ¥ç”¨ã€‘
         * 
         * åŠŸèƒ½è¯´æ˜ï¼š
         * 1. è°ƒç”¨ getLocalEditData() è·å–ç”¨æˆ·ç¼–è¾‘çš„æ•°æ®
         * 2. é€šè¿‡ postMessage ä¸çˆ¶é¡µé¢é€šä¿¡ï¼Œå‘é€å‘å¸ƒè¯·æ±‚
         * 3. ç›‘å¬çˆ¶é¡µé¢è¿”å›çš„å‘å¸ƒç»“æœ
         * 4. å¤„ç†å‘å¸ƒè¿‡ç¨‹ä¸­çš„UIçŠ¶æ€å’Œç”¨æˆ·åé¦ˆ
         * 
         * é€šä¿¡åè®®ï¼š
         * å‘é€ç»™çˆ¶é¡µé¢ï¼š
         * {
         *   type: 'gamePublish',
         *   title: string,        // æ¸¸æˆæ ‡é¢˜
         *   description: string,  // æ¸¸æˆæè¿°
         *   zipBlob: Blob        // MODæ•°æ®çš„ZIPåŒ…
         * }
         * 
         * æ¥æ”¶çˆ¶é¡µé¢è¿”å›ï¼š
         * {
         *   type: 'publishResult',
         *   success: boolean,     // å‘å¸ƒæ˜¯å¦æˆåŠŸ
         *   error?: string,       // é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
         *   redirectUrl?: string  // é‡å®šå‘URLï¼ˆæˆåŠŸæ—¶ï¼‰
         * }
         * 
         * ç”¨æˆ·ä½“éªŒï¼š
         * - ç‚¹å‡»"å‘å¸ƒåŒæ¬¾"æŒ‰é’®æ—¶è°ƒç”¨
         * - å‘å¸ƒè¿‡ç¨‹ä¸­æŒ‰é’®æ˜¾ç¤º"å‘å¸ƒä¸­..."å¹¶ç¦ç”¨
         * - æˆåŠŸåæ›´æ–°æ¸¸æˆçŠ¶æ€ä¸ºå·²å‘å¸ƒï¼Œå¯é€‰æ‹©è·³è½¬åˆ°ç»“æœé¡µé¢
         * - å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶æ¢å¤æŒ‰é’®çŠ¶æ€
         * - 30ç§’è¶…æ—¶ä¿æŠ¤
         * 
         * æ³¨æ„äº‹é¡¹ï¼š
         * - æ­¤å‡½æ•°ç”¨äºiframeåµŒå…¥åœºæ™¯ï¼Œä¸çˆ¶é¡µé¢é€šä¿¡
         * - ä¾èµ–DOMå…ƒç´ ï¼š#publishBtnï¼ˆå‘å¸ƒæŒ‰é’®ï¼‰
         * - ä¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼šwindow.gameData.status
         * - ç›‘å¬æ¶ˆæ¯æ—¶æœ‰è¶…æ—¶æœºåˆ¶ï¼Œé¿å…å†…å­˜æ³„æ¼
         */
        async function publishLocalEdit() {
            try {
                const btn = document.getElementById('publishBtn');
                btn.disabled = true;
                btn.textContent = 'å‘å¸ƒä¸­...';
                
                const publishData = await getLocalEditData();

                window.parent.postMessage({
                    type: 'gamePublish',
                    title: publishData.title,
                    description: publishData.description,
                    zipBlob: publishData.zipBlob
                }, '*');
                
                const messageHandler = (event) => {
                    const data = event.data;
                    if (data.type === 'publishResult') {
                        window.removeEventListener('message', messageHandler);
                        btn.disabled = false;
                        btn.textContent = 'å‘å¸ƒåŒæ¬¾';
                        
                        if (data.success) {
                            alert('å‘å¸ƒæˆåŠŸ!');
                            window.gameData.status = 'PUBLISHED';
                            // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                            if (typeof updateStatusDisplay === 'function') {
                                updateStatusDisplay();
                            }
                            
                            if (data.redirectUrl) {
                                window.location.href = data.redirectUrl;
                            }
                        } else {
                            alert('å‘å¸ƒå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    }
                };
                window.addEventListener('message', messageHandler);
                
                // 30ç§’è¶…æ—¶ä¿æŠ¤
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    btn.disabled = false;
                    btn.textContent = 'å‘å¸ƒåŒæ¬¾';
                }, 30000);
                
            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                alert('å‘å¸ƒå¤±è´¥: ' + error.message);
                
                const btn = document.getElementById('publishBtn');
                btn.disabled = false;
                btn.textContent = 'å‘å¸ƒåŒæ¬¾';
            }
        }

        /**
         * ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
         * æ”¯æŒå¤–éƒ¨è§¦å‘å‘å¸ƒåŠŸèƒ½
         */
        window.addEventListener('message', function(event) {
            const data = event.data;
            if (data && data.type === 'requestSave') {
                publishLocalEdit();
            }
        });

        /* ========================================================================
         * è¾…åŠ©å‡½æ•°
         * ========================================================================
         */

        /**
         * å°†å›¾ç‰‡è½¬æ¢ä¸ºPNGæ ¼å¼
         * ç”¨äºç¡®ä¿æ‰€æœ‰æ•Œäººå¤´åƒéƒ½æ˜¯PNGæ ¼å¼ï¼Œä¾¿äºæ¸¸æˆå¼•æ“å¤„ç†
         */
        function convertImageToPng(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(resolve, 'image/png');
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        /* ========================================================================
         * ä»¥ä¸‹å‡½æ•°å·²è¿ç§»åˆ° editorResource/ æ¨¡å—ä¸­ï¼Œç”±å‰ç«¯å›¢é˜Ÿç»´æŠ¤
         * ========================================================================
         * - é¡µé¢åˆå§‹åŒ–ï¼šeditor_main.js
         * - æ–‡ä»¶ä¸Šä¼ å¤„ç†ï¼šeditor_main.js  
         * - localStorageç®¡ç†ï¼šlocalStorage_manager.js
         * - AIæ•°æ®ç”Ÿæˆï¼šai_integration.js
         * - æµ‹è¯•ä¸‹è½½åŠŸèƒ½ï¼šgame_test_manager.js
         */
    </script>
</body>
</html> 